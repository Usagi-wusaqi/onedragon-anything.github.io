---
lang: zh-CN
title: 全配队通用 - 架构解析
---

本文以 `全配队通用` 战斗配置为例，解析其核心的事件驱动架构与模块化设计思想。

> 阅读本文前，建议先掌握 [场景系统](../basic/basic_02_scenes.md) 和 [模板系统](../basic/basic_05_templates.md)。

---

## 1. 设计哲学

`全配队通用` 的核心思想是**模块化**与**事件驱动分层**。它将战斗逻辑拆分为三层：

| 层级 | 目录 | 职责 | 比喻 |
|---|---|---|---|
| 战略层 | `auto_battle/` | 监听事件，设定优先级，分派任务 | 项目经理 |
| 决策层 | `auto_battle_state_handler/` | 处理特定事件或角色的决策逻辑 | 各领域专家 |
| 动作层 | `auto_battle_operation/` | 执行具体的按键连招 | 手和脚 |

通过将 **"何时做"（战略）**、**"做什么"（决策）** 和 **"如何做"（动作）** 分离，可以适应任意角色组合，而无需为每个队伍编写独立的顶层脚本。

---

## 2. 文件结构

```
config/
├── auto_battle/
│   └── 全配队通用.yml              ← 顶层战略（事件调度中心）
│
├── auto_battle_state_handler/
│   ├── 速切模板-全角色.yml         ← 角色分派器
│   ├── 速切模板-安比.yml           ← 角色专属"大脑"
│   ├── 轮换-救命-全角色.yml       ← 通用保命逻辑
│   ├── 轮换-合轴-全角色.yml       ← 通用合轴换人
│   ├── 轮换-紧急-全角色.yml       ← 紧急换人检查
│   └── ...
│
└── auto_battle_operation/
    ├── 艾莲-冲刺蓄力攻击.yml       ← 原子化连招
    └── ...
```

---

## 3. 事件调度中心

`全配队通用.yml` 定义了多个场景（`scenes`），每个场景监听不同的游戏事件。它**不直接处理**具体逻辑，而是通过 `state_template` 将任务分派给对应的"专家模板"。

### 状态引用树

```
【全配队通用】
     │
     ├─ scene: [闪避事件] (priority: 99)
     │   ├─ "支援攻击模板-*"   → 黄光/格挡 → 支援攻击
     │   └─ "闪A模板-全角色"   → 红光/声音 → 闪避反击
     │
     ├─ scene: [连携事件] (priority: 98)
     │   └─ "连携模板-通用"    → 连携技选人
     │
     ├─ scene: [快速支援事件] (priority: 97)
     │   └─ "快速支援模板-全角色" → 快速支援
     │
     ├─ scene: [受击事件] (priority: 90)
     │   ├─ "轮换-救命-全角色" → 低血量? 切人开大!
     │   └─ "闪A模板-全角色"   → 受击闪避反击
     │
     ├─ scene: [连招结束事件] (priority: 80)
     │   └─ "轮换-合轴-全角色" → 需要补Buff? 换人!
     │
     └─ scene: [默认循环] (priority: 9)
         ├─ "站场模板-未识别角色" → 前置：角色识别检查
         ├─ "自动锁定模板"       → 前置：锁定目标
         ├─ "轮换-紧急-全角色"   → 前置：紧急换人检查
         │
         └─ "速切模板-全角色"    → 角色分派器
             ├─ "速切模板-安比"
             ├─ "速切模板-艾莲"
             └─ ...（各角色专属模板）
```

### 优先级解读

| 优先级 | 事件 | 说明 |
|---|---|---|
| 99 | 闪避 | 最高优，确保闪避不被打断 |
| 98 | 连携 | 连携技窗口稍纵即逝 |
| 97 | 快速支援 | 快速支援机会 |
| 90 | 受击 | 保命优先于输出 |
| 80 | 连招结束 | 合轴换人时机 |
| 9 | 默认循环 | 常规输出循环 |

高优先级场景会**抢占**低优先级场景正在执行的操作。例如：角色正在执行普攻连段（优先级 9），此时检测到红光反击机会（优先级 99），系统会立即中断普攻，执行闪避。

---

## 4. 关键模板解析

### 4.1 速切模板-全角色（角色分派器）

唯一职责：判断当前站场角色，将控制权交给该角色的专属"大脑"。

```yaml
handlers:
  - state_template: "速切模板-安比"    # 安比在前台时生效
  - state_template: "速切模板-艾莲"    # 艾莲在前台时生效
  - state_template: "速切模板-朱鸢"
  # ...
```

### 4.2 角色专属模板（角色的"大脑"）

定义角色在前台时的输出决策树。连招结束后通过设置状态发出"可换人"信号：

```yaml
# 速切模板-安比.yml
handlers:
  - states: "[前台-安比]"
    sub_handlers:
      # 优先检查是否有终结技
      - states: "[前台-终结技可用]"
        operations:
          - op_name: "按键-终结技"

      # 常规输出
      - states: ""
        operations:
          - operation_template: "安比-3A特殊攻击"
          - op_name: "设置状态"
            state: "自定义-合轴时间"    # 信号：我打完了，可以换人
```

### 4.3 轮换模板（团队协作）

三个轮换模板各司其职：

- **轮换-救命-全角色**：低血量触发，切人开大保命
- **轮换-合轴-全角色**：连招结束后触发（由 `自定义-合轴时间` 状态），判断是否补增益换人
- **轮换-紧急-全角色**：每次主循环前检查，处理突发的换人需求

---

## 5. 设计优势

这种架构的核心优势：

1. **添加新角色简单**：只需创建角色的操作模板和速切模板，注册到分派器即可。详见 [如何新增角色](add_character.md)
2. **修改策略不影响全局**：修改闪避策略只需改闪A模板，不需要动顶层配置
3. **通用逻辑复用**：轮换、连携、支援攻击等逻辑对所有配队通用
4. **优先级清晰**：事件驱动的抢占模型确保紧急事件总能及时响应
